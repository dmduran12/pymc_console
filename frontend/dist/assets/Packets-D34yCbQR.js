import{c as E,j as e,d as I,m as O,R as q,X as H,P as U}from"./index-B37AHdiD.js";import{b as n,c as j}from"./recharts-CHDYrIv-.js";import{c as M,d as Y,A as z,C as G,e as A,R as L,g as S,P as X,a as B,b as V}from"./PacketDetailModal-CIH5cOfZ.js";import{u as W}from"./usePolling-CTxkEuwk.js";import{C as J}from"./HashBadge-CsSeJ4jR.js";import{U as K}from"./users-9S0Gcwmu.js";import{P as Q,a as Z,C as F}from"./PageLayout-Bk77Qfbb.js";import{C as $}from"./circle-BQSSv77o.js";import{R as ee}from"./refresh-cw-BGdR-336.js";import"./maplibre-gl-Cg9ukl_k.js";import"./SignalIndicator-BRQdv7-e.js";import"./triangle-alert-CAX7rb0d.js";/**
 * @license lucide-react v0.559.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],T=E("funnel",te);function f({icon:l,label:i,value:d,color:m,percentage:c}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:j("p-1.5 rounded-md",m),children:l}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-semibold text-text-primary",children:d.toLocaleString()}),e.jsxs("span",{className:"text-[10px] text-text-muted leading-tight",children:[i,c!==void 0&&e.jsxs("span",{className:"ml-1 opacity-70",children:["(",c,"%)"]})]})]})]})}function se({packets:l}){const i=n.useMemo(()=>{let d=0,m=0,c=0;const v=new Set;let b=0,u=0;for(const x of l){switch(M(x)){case"forward":d++;break;case"dropped":m++;break;case"duplicate":c++;break}x.src_hash&&v.add(x.src_hash),x.rssi&&(b+=x.rssi,u++)}const o=l.length,y=u>0?Math.round(b/u):0;return{total:o,rx:o,fwd:d,dropped:m,duplicate:c,uniqueSources:v.size,avgRssi:y,rxPercent:100,fwdPercent:o>0?Math.round(d/o*100):0,droppedPercent:o>0?Math.round(m/o*100):0}},[l]);return l.length===0?null:e.jsx("div",{className:"glass-card p-3 pr-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:flex sm:items-center sm:justify-between sm:gap-6",children:[e.jsx(f,{icon:e.jsx(Y,{className:"w-3.5 h-3.5 text-accent-primary"}),label:"Received",value:i.rx,color:"bg-accent-primary/10",percentage:i.rxPercent}),e.jsx(f,{icon:e.jsx(z,{className:"w-3.5 h-3.5 text-accent-success"}),label:"Forwarded",value:i.fwd,color:"bg-accent-success/10",percentage:i.fwdPercent}),e.jsx(f,{icon:e.jsx(G,{className:"w-3.5 h-3.5 text-accent-danger"}),label:"Dropped",value:i.dropped,color:"bg-accent-danger/10",percentage:i.droppedPercent}),e.jsx(f,{icon:e.jsx(J,{className:"w-3.5 h-3.5 text-text-muted"}),label:"Duplicates",value:i.duplicate,color:"bg-white/5"}),e.jsxs("div",{className:"hidden sm:flex items-center gap-6 ml-auto",children:[e.jsx(f,{icon:e.jsx(K,{className:"w-3.5 h-3.5 text-accent-secondary"}),label:"Sources",value:i.uniqueSources,color:"bg-accent-secondary/10"}),e.jsxs("div",{className:"flex flex-col items-end pr-1",children:[e.jsxs("span",{className:"text-sm font-mono text-text-secondary",children:[i.avgRssi," dBm"]}),e.jsx("span",{className:"text-[10px] text-text-muted",children:"Avg Signal"})]})]})]})})}const ae=n.memo(se);function be(){const[l,i]=n.useState([]),[d,m]=n.useState(!0),[c,v]=n.useState(!0),[b,u]=n.useState(null),[o,y]=n.useState(!1),[s,x]=n.useState({limit:100,status:"all"}),g=I(),[R,C]=n.useState(null),_=n.useRef(0),N=n.useCallback(async()=>{try{const t=await O(s.limit||100);t.success&&t.data&&i(t.data)}catch{}finally{m(!1)}},[s.limit]),p=n.useMemo(()=>{let t=l;if(s.type!==void 0){const a=A[s.type];t=t.filter(r=>{const k=r.type??r.payload_type,P=r.payload_type_name;return k===s.type||P===a})}if(s.route!==void 0){const a=L[s.route];t=t.filter(r=>{const k=r.route??r.route_type,P=r.route_type_name;return k===s.route||P===a})}if(s.status&&s.status!=="all"&&(t=t.filter(a=>M(a)===s.status)),s.signalMin!==void 0&&(t=t.filter(a=>a.rssi>=s.signalMin)),s.timeRange&&s.timeRange>0){const a=Date.now()/1e3-s.timeRange*3600;t=t.filter(r=>r.timestamp>=a)}return t},[l,s.type,s.route,s.status,s.signalMin,s.timeRange]);n.useEffect(()=>{N()},[N]),W(N,U.packets,c,!0),n.useEffect(()=>{if(g>0&&g!==_.current&&l.length>0){_.current=g;const t=l.find(a=>(a.payload_type_name||S(a.payload_type??a.type)).toLowerCase().includes("advert"));if(t){const a=requestAnimationFrame(()=>C(t.packet_hash)),r=setTimeout(()=>C(null),600);return()=>{cancelAnimationFrame(a),clearTimeout(r)}}}},[g,l]);const h=(t,a)=>{x(r=>({...r,[t]:a}))},D=()=>{x({limit:s.limit,status:"all"})},w=s.type!==void 0||s.route!==void 0||s.status&&s.status!=="all"||s.signalMin!==void 0||s.timeRange&&s.timeRange>0;return e.jsxs(Q,{children:[e.jsx(Z,{title:"Packet History",icon:e.jsx(q,{}),controls:e.jsxs(e.Fragment,{children:[c&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx($,{className:"w-1.5 h-1.5 fill-accent-success text-accent-success animate-pulse"}),e.jsx("span",{className:"text-text-muted hidden xs:inline",children:"Live"})]}),e.jsxs("button",{onClick:()=>y(!o),className:j("sm:hidden px-3 py-1.5 rounded-lg text-sm font-medium transition-all","flex items-center gap-1.5 border",w?"bg-accent-primary/20 text-accent-primary border-accent-primary/30":"bg-bg-subtle text-text-muted border-border-subtle"),children:[e.jsx(T,{className:"w-4 h-4"}),w&&e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-accent-primary"})]}),e.jsxs("button",{onClick:()=>v(!c),className:j("px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200","flex items-center gap-1.5 border",c?"bg-accent-success/20 text-accent-success border-accent-success/30":"bg-bg-subtle text-text-muted border-border-subtle hover:bg-bg-elevated"),children:[e.jsx(ee,{className:j("w-4 h-4",c&&"animate-spin")}),e.jsx("span",{className:"hidden xs:inline",children:c?"Live":"Paused"})]})]})}),e.jsx(F,{noPadding:!0,className:j("overflow-hidden transition-all duration-200",o?"max-h-96 opacity-100":"max-h-0 opacity-0 sm:max-h-96 sm:opacity-100"),children:e.jsxs("div",{className:"p-3 sm:p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4 text-accent-primary"}),e.jsx("span",{className:"text-sm text-text-primary font-medium",children:"Filters"})]}),w&&e.jsxs("button",{onClick:D,className:"text-xs text-text-muted hover:text-text-primary flex items-center gap-1",children:[e.jsx(H,{className:"w-3 h-3"})," Clear"]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:flex sm:flex-wrap gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-[120px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Type"}),e.jsxs("select",{value:s.type??"",onChange:t=>h("type",t.target.value?Number(t.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:"",children:"All Types"}),Object.entries(A).map(([t,a])=>e.jsx("option",{value:t,children:a},t))]})]}),e.jsxs("div",{className:"flex-1 min-w-[120px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Route"}),e.jsxs("select",{value:s.route??"",onChange:t=>h("route",t.target.value?Number(t.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:"",children:"All Routes"}),Object.entries(L).map(([t,a])=>e.jsx("option",{value:t,children:a},t))]})]}),e.jsxs("div",{className:"flex-1 min-w-[120px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Status"}),e.jsxs("select",{value:s.status??"all",onChange:t=>h("status",t.target.value),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"rx",children:"Received"}),e.jsx("option",{value:"forward",children:"Forwarded"}),e.jsx("option",{value:"dropped",children:"Dropped"}),e.jsx("option",{value:"duplicate",children:"Duplicate"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[100px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Time"}),e.jsxs("select",{value:s.timeRange??0,onChange:t=>h("timeRange",Number(t.target.value)||void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:0,children:"All Time"}),e.jsx("option",{value:1,children:"Last 1h"}),e.jsx("option",{value:6,children:"Last 6h"}),e.jsx("option",{value:24,children:"Last 24h"}),e.jsx("option",{value:168,children:"Last 7d"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[100px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Signal"}),e.jsxs("select",{value:s.signalMin??"",onChange:t=>h("signalMin",t.target.value?Number(t.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:"",children:"Any Signal"}),e.jsx("option",{value:-90,children:"Strong (≥-90)"}),e.jsx("option",{value:-100,children:"Good (≥-100)"}),e.jsx("option",{value:-110,children:"Fair (≥-110)"}),e.jsx("option",{value:-120,children:"Weak (≥-120)"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[80px]",children:[e.jsx("label",{className:"block text-[10px] text-text-muted mb-1 uppercase tracking-wide",children:"Limit"}),e.jsxs("select",{value:s.limit??100,onChange:t=>h("limit",Number(t.target.value)),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"}),e.jsx("option",{value:200,children:"200"}),e.jsx("option",{value:500,children:"500"})]})]})]})]})}),e.jsx(ae,{packets:p}),e.jsxs(F,{noPadding:!0,children:[e.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-2 border-b border-border-subtle bg-bg-elevated/30",children:[e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),e.jsx("span",{className:"text-[10px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),e.jsx("div",{className:"hidden sm:block overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border-subtle bg-bg-elevated/30",children:[e.jsx("th",{className:"text-left py-2.5 px-3 text-[10px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),e.jsx("th",{className:"text-left py-2.5 px-3 text-[10px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),e.jsx("th",{className:"text-left py-2.5 px-3 text-[10px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),e.jsx("th",{className:"text-left py-2.5 px-3 text-[10px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"text-left py-2.5 px-3 text-[10px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),e.jsx("th",{className:"text-right py-2.5 px-3 pr-4 text-[10px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),e.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:d&&l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center py-12 text-text-muted",children:"Loading packets..."})}):p.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center py-12 text-text-muted",children:"No packets found"})}):p.map(t=>{const r=(t.payload_type_name||S(t.payload_type??t.type)).toLowerCase().includes("advert");return e.jsx(X,{packet:t,onClick:u,isFlashing:r&&R===t.packet_hash},t.packet_hash)})})]})}),e.jsx("div",{className:"sm:hidden divide-y divide-border-subtle/30",children:d&&l.length===0?e.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):p.length===0?e.jsx("div",{className:"p-8 text-center text-text-muted",children:"No packets found"}):p.map(t=>{const r=(t.payload_type_name||S(t.payload_type??t.type)).toLowerCase().includes("advert");return e.jsx(B,{packet:t,onClick:u,isFlashing:r&&R===t.packet_hash},t.packet_hash)})}),e.jsxs("div",{className:"px-3 py-2 border-t border-border-subtle text-xs text-text-muted bg-bg-elevated/20 sm:text-left text-center",children:["Showing ",p.length," of ",l.length," packets"]})]}),b&&e.jsx(V,{packet:b,onClose:()=>u(null)})]})}export{be as default};
